image: node:14-buster

cache:
    paths:
        - node_modules/

stages:
    - prepare
    - test

apt:
    stage: prepare
    script:
        - apt-get update -y -qq
        - DEBIAN_FRONTEND=noninteractive apt-get install -y -qq git libpcre3 libpcre2-posix0 libkrb5-3 libk5crypto3 libcom-err2 libssl1.1 libssl-dev

yarn-install:
    stage: prepare
    script:
        - yarn install

test:
    stage: test
    before_script:
        - gpg --keyserver keys.openpgp.org --receive-keys 9C0309603A7DA7CE3F1B2CE7B7D6FB9B7AFDF0DE
    script:
        - yarn test --ci=true

eslint:
    stage: test
    before_script:
      - >
        echo -e "host: localhost\nport: 8080\ndev_port: 8008\ntitle: test" > settings.yml
    script:
        - yarn eslint packages/server
        - yarn workspace client lint